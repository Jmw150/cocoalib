-----------------------------------------------------------------------
-- TestPrimaryDecomposition0:
-----------------------------------------------------------------------
TestCount := 0;
PrintInfo := false;

define TEST_ASSERT(A,B)
  toplevel TestCount;
  toplevel PrintInfo;
  TestCount := TestCount+1;
  If A<>B Then
    error("TEST: " + Sprint(A) + " <> " + Sprint(B));
  endif;
  if PrintInfo then print "."; EndIf;
enddefine; -- TEST_ASSERT
-----------------------------------------------------------------------//5.3.7
Use P::=QQ[x,y,z]; 
f1 := y*z-2*z^2-x-4*z;
f2 := z^3-y+2*z+1;
f3 := x^2-2*x*y+34*y^2-56*x*z+1369*z^2+256*x-794*y-448*z+2091;

I := ideal(f1, f2, f3);
//L := 3*x+2*y-7*z;


-- PD := PrimaryDecompositionCore0(I,L);
-- TEST_ASSERT(IsPrimary(PD.PrDec_I[1]), true);
-- TEST_ASSERT(IsPrimary(PD.PrDec_I[2]), true);

-- TEST_ASSERT(EqSet(PD.PrDec_I, [ideal(9*x^2 +12*x*y +4*y^2 -42*x*z -28*y*z +49*z^2 +30*x +20*y -70*z +25, y*z -2*z^2 -x -4*z, z^3 -y +2*z +1, x^2 -2*x*y +34*y^2 -56*x*z +1369*z^2 +256*x -794*y -448*z +2091), ideal(729*x^6 +2916*x^5*y +4860*x^4*y^2 +4320*x^3*y^3 +2160*x^2*y^4 +576*x*y^5 +64*y^6 -10206*x^5*z -34020*x^4*y*z -45360*x^3*y^2*z -30240*x^2*y^3*z -10080*x*y^4*z -1344*y^5*z +59535*x^4*z^2 +158760*x^3*y*z^2 +158760*x^2*y^2*z^2 +70560*x*y^3*z^2 +11760*y^4*z^2 -185220*x^3*z^3 -370440*x^2*y*z^3 -246960*x*y^2*z^3 -54880*y^3*z^3 +324135*x^2*z^4 +432180*x*y*z^4 +144060*y^2*z^4 -302526*x*z^5 -201684*y*z^5 +117649*z^6 -532170*x^5 -1773900*x^4*y -2365200*x^3*y^2 -1576800*x^2*y^3 -525600*x*y^4 -70080*y^5 +6208650*x^4*z +16556400*x^3*y*z +16556400*x^2*y^2*z +7358400*x*y^3*z +1226400*y^4*z -28973700*x^3*z^2 -57947400*x^2*y*z^2 -38631600*x*y^2*z^2 -8584800*y^3*z^2 +67605300*x^2*z^3 +90140400*x*y*z^3 +30046800*y^2*z^3 -78872850*x*z^4 -52581900*y*z^4 +36807330*z^5 +164958363*x^4 +439888968*x^3*y +439888968*x^2*y^2 +195506208*x*y^3 +32584368*y^4 -1539611388*x^3*z -3079222776*x^2*y*z -2052815184*x*y^2*z -456181152*y^3*z +5388639858*x^2*z^2 +7184853144*x*y*z^2 +2394951048*y^2*z^2 -8382328668*x*z^3 -5588219112*y*z^3 +4889691723*z^4 -27762441660*x^3 -55524883320*x^2*y -37016588880*x*y^2 -8225908640*y^3 +194337091620*x^2*z +259116122160*x*y*z +86372040720*y^2*z -453453213780*x*z^2 -302302142520*y*z^2 +352685832940*z^3 +2674909828287*x^2 +3566546437716*x*y +1188848812572*y^2 -12482912532006*x*z -8321941688004*y*z +14563397954007*z^2 -139932954910170*x -93288636606780*y +326510228123730*z +3108364592472621, y*z -2*z^2 -x -4*z, z^3 -y +2*z +1, x^2 -2*x*y +34*y^2 -56*x*z +1369*z^2 +256*x -794*y -448*z +2091)]), true);

PD := PrimaryDecomposition(I);

TEST_ASSERT(EqSet(PD, [ideal(400*x^2 +3560*x*y +7921*y^2 +1880*x*z +8366*y*z +2209*z^2 -14520*x -64614*y -34122*z +131769, y*z -2*z^2 -x -4*z, z^3 -y +2*z +1, x^2 -2*x*y +34*y^2 -56*x*z +1369*z^2 +256*x -794*y -448*z +2091), ideal(64000000*x^6 +1708800000*x^5*y +19010400000*x^4*y^2 +112795040000*x^3*y^3 +376453446000*x^2*y^4 +670087133880*x*y^5 +496981290961*y^6 +902400000*x^5*z +20078400000*x^4*y*z +178697760000*x^3*y^2*z +795205032000*x^2*y^3*z +1769331196200*x*y^4*z +1574704764618*y^5*z +5301600000*x^4*z^2 +94368480000*x^3*y*z^2 +629909604000*x^2*y^2*z^2 +1868731825200*x*y^3*z^2 +2078964155535*y^4*z^2 +16611680000*x^3*z^3 +221765928000*x^2*y*z^3 +986858379600*x*y^2*z^3 +1463839929740*y^3*z^3 +29278086000*x^2*z^4 +260574965400*x*y*z^4 +579779298015*y^2*z^4 +27521400840*x*z^5 +122470233738*y*z^5 +10779215329*z^6 -48172800000*x^5 -1071844800000*x^4*y -9539418720000*x^3*y^2 -42450413304000*x^2*y^3 -94452169601400*x*y^4 -84062430945246*y^5 -566030400000*x^4*z -10075341120000*x^3*y*z -67252901976000*x^2*y^2*z -199516942528800*x*y^3*z -221962598563290*y^4*z -2660342880000*x^3*z^2 -35515577448000*x^2*y*z^2 -158044319643600*x*y^2*z^2 -234432407471340*y^3*z^2 -6251805768000*x^2*z^3 -55641071335200*x*y*z^3 -123801383720820*y^2*z^3 -7345871777400*x*z^4 -32689129409430*y*z^4 -3452559735378*z^5 +18606701280000*x^4 +331199282784000*x^3*y +2210755212583200*x^2*y^2 +6558573797330160*x*y^3 +7296413349529803*y^4 +174902992032000*x^3*z +2334954943627200*x^2*y*z +10390549499141040*x*y^2*z +15412648423725876*y^3*z +616533046912800*x^2*z^2 +5487144117523920*x*y*z^2 +12208895661490722*y^2*z^2 +965901773496720*x*z^3 +4298262892060404*y*z^3 +567467291929323*z^4 -4282648069024000*x^3 -57173351721470400*x^2*y -254421415160543280*x*y^2 -377391765821472532*y^3 -30192668886619200*x^2*z -268714753090910880*x*y*z -597890325627276708*y^2*z -70952771883555120*x*z^2 -315739834881820284*y*z^2 -55579671308784844*z^3 +631866689887388400*x^2 +5623613539997756760*x*y +12512540126495008791*y^2 +2969773442470725480*x*z +13215491818994728386*y*z +3489483794903102439*z^2 -55553834654010290520*x -247214564210345792814*y -130551511436924182722*z +2506387418287818455853, y*z -2*z^2 -x -4*z, z^3 -y +2*z +1, x^2 -2*x*y +34*y^2 -56*x*z +1369*z^2 +256*x -794*y -448*z +2091)]), true); 

-----------------------------------------------------------------------
//5.3.8
Use P::=QQ[x,y];
g1 := x^3-5*x^2+8*x-4;
g2 := x^2*y+2*x^2-12*x-4*y+16;
g3 := x*y+x^2-5*x-2*y+6;
g4 := y^2-x^2+4*x-2*y-3;

I := ideal(g1,g2,g3,g4);
//L := 23*x+(1/2)*y;

-- PD := PrimaryDecompositionCore0(I,L);
-- TEST_ASSERT(EqSet(PD.PrDec_I, [ideal(23*x +(1/2)*y -24, x^3 -5*x^2 +8*x -4, x^2*y +2*x^2 -12*x -4*y +16, x^2 +x*y -5*x -2*y +6, -x^2 +y^2 +4*x -2*y -3), ideal(2116*x^2 +92*x*y +y^2 -8556*x -186*y +8649, x^3 -5*x^2 +8*x -4, x^2*y +2*x^2 -12*x -4*y +16, x^2 +x*y -5*x -2*y +6, -x^2 +y^2 +4*x -2*y -3)]), true);

P := PrimaryDecomposition(I);
TEST_ASSERT(EqSet(P,[ideal(23*x +(1/2)*y -24, x^3 -5*x^2 +8*x -4, x^2*y +2*x^2 -12*x -4*y +16, x^2 +x*y -5*x -2*y +6, -x^2 +y^2 +4*x -2*y -3), ideal(2116*x^2 +92*x*y +y^2 -8556*x -186*y +8649, x^3 -5*x^2 +8*x -4, x^2*y +2*x^2 -12*x -4*y +16, x^2 +x*y -5*x -2*y +6, -x^2 +y^2 +4*x -2*y -3)]), true);


-----------------------------------------------------------------------
// 5.3.9
Use QQ[x,y];
I := ideal(x*y, y^3-y^2, x^3+2*x^2);

PD := PrimaryDecomposition(I);

TEST_ASSERT(EqSet(PD, [ideal(13*x -47*y +26, x*y, y^3 -y^2, x^3 +2*x^2), ideal(13*x -47*y +47, x*y, y^3 -y^2, x^3 +2*x^2), ideal(169*x^2 -1222*x*y +2209*y^2, x*y, y^3 -y^2, x^3 +2*x^2)]), true);


-----------------------------------------------------------------------
// 5.3.9
Use QQ[x,y];
I := ideal(x-1, y)^2;
PD := PrimaryDecomposition(I);
TEST_ASSERT(EqSet(PD, [I]), true);

I := ideal(x,y)^2; // 0-dim & monomial
PD := PrimaryDecomposition(I);
TEST_ASSERT(EqSet(PD, [I]), true);


--========================================================================
-- char p
--========================================================================
--------------------------------------------------------------------
-- Esempio #P>d-r:
K::= ZZ/(5);
Use P ::= K[x,y,z];
I := ideal(y^2-x*z, z^2-x^2*y, x+y+z-1);
Q := PrimaryDecomposition(I);
TEST_ASSERT(EqSet(Q,[ideal(z -2, y -1, x +2), ideal(y +2*z +1, x -z -2, z^2 -z +2), ideal(z, y, x -1), ideal(z +2, x +y +2, y^2 -2*y +1)]), true);
//qui fa un giro solo e mi conta tutto

--------------------------------------------------------------------
-- Esempio #P<d-r:
Use P::= ZZ/(2)[x,y];
Q1:=ideal(x,y)^3; Q2:=ideal(x+1, y^2)^2; Q3:=ideal(x^3,(y+1)^2); Q4:=ideal(x+1, y+1);
Q := [Q1, Q2, Q3, Q4];
I := IntersectionList(Q);
PrDec := PrimaryDecomposition(I);
TEST_ASSERT(EqSet(PrDec, Q), true);
//qui fa due o tre giri!

--------------------------------------------------------------------
-- Esempio #P<<d-r: 
Use P::= ZZ/(2)[x,y,z,w];
Q1:=ideal(x,y,z,w)^3;
Q2:=ideal(x+1, y+1, z+1, w^2)^2;
Q3:=ideal(x^3,(y+1)^2, (z+1)^3, w^2);
Q4:=ideal(x, y, (z+1)^3, w^2);
Q5:=ideal(x+1, y^2, z+1, w+1)^2;
Q6:=ideal(x^2,(y+1)^3, z+1, w+1)^3;
Q7:=ideal(x+1, y+1, z+1, w+1);
Q8:=ideal(x+1, y^2, z^2, (w+1)^3)^2;

Q := [Q1, Q2, Q3, Q4, Q5, Q6, Q7, Q8];
I := IntersectionList(Q);
PrDec := PrimaryDecomposition(I);
TEST_ASSERT(EqSet(PrDec, Q), true);

--------------------------------------------------------------------
-- Esempio #P<d-r:
Use P::= ZZ/(2)[x,y];
Q := [ideal(x^2 +y +x +1, y*x +x +1, y^2 +x),
      ideal(x^2 +y, y*x +y +1, y^2 +y +x +1)];
I:=IntersectionList(Q);
PrDec :=PrimaryDecomposition(I);
TEST_ASSERT(EqSet(PrDec, Q), true);

--------------------------------------------------------------------
-- Esempio extension:
Use R ::= ZZ/(101)[a,b];
K := R/ideal(a^3 -10*a^2 -29*a -47,  b^5-b-2);
Use P ::= K[x,y];
I := ideal(x^2 +y +x +1, y^5-y-2);
Q := [
  ideal(x^2 +x +(21*b^4 +45*b^3 -35*b^2 +12*b -36),  x^2 +x +y +(1),  y^5 +(-1)*y +(-2)),
  ideal(x^2 +x +(15*b^4 -34*b^3 -34*b^2 -45*b -11),  x^2 +x +y +(1),  y^5 +(-1)*y +(-2)),
  ideal(x^2 +x +(-37*b^4 -5*b^3 -13*b^2 -26*b -30),  x^2 +x +y +(1),  y^5 +(-1)*y +(-2)),
  ideal(x^2 +x +(b +1),  x^2 +x +y +(1),  y^5 +(-1)*y +(-2)),
  ideal(x^2 +x +(b^4 -6*b^3 -19*b^2 -43*b -20),  x^2 +x +y +(1),  y^5 +(-1)*y +(-2))
      ];
PrDec := PrimaryDecomposition(I);
TEST_ASSERT(EqSet(PrDec, Q), true);

------------------------------------------------------------------
-- See redmine bug 1100

use QQ[x,y,z];
L := [3*x*y*z^3 +z^2 +1,  3*y^3*z +z^2,  2*x*y^2*z^2 +3*x*y*z^2];
I := ideal(L);
PD := PrimaryDecomposition(I);
TEST_ASSERT(EqSet([LT(J) | J in PD], [ideal(x, z^2, y^3),  ideal(z, y, x)]),
	    true);

L := [x^2*y^2 +3*y^3*z +1,  2*x*y*z^2 +2*x*y^2,  2*y^3 +3];
I := ideal(L);
PD := PrimaryDecomposition(I);
TEST_ASSERT(EqSet([LT(J) | J in PD],
		  [ideal(z,  x,  y^3),  ideal(z^2,  x^2,  y^3)]),
	    true);

-- #6
I := ideal(x^4 +x^2 +1,  y^4 +y,  z^4 +z);
PD := PrimaryDecomposition(I);
TEST_ASSERT(EqSet(PD,
		  [ideal(z +1,  y +1,  x^2 +x +1),
  ideal(z,  y +1,  x^2 +x +1),
  ideal(y +1,  z^2 -z +1,  x^2 +x +1,  -4*x*z +2*x -2*z +4),
  ideal(y +1,  z^2 -z +1,  x^2 +x +1,  -4*x*z +2*x -2*z -2),
  ideal(z +1,  y,  x^2 +x +1),
  ideal(z,  y,  x^2 +x +1),
  ideal(y,  z^2 -z +1,  x^2 +x +1,  4*x*z -2*x +2*z -4),
  ideal(y,  z^2 -z +1,  x^2 +x +1,  4*x*z -2*x +2*z +2),
  ideal(z +1,  y^2 -y +1,  x^2 +x +1,  6*x*y -3*x +3*y -6),
  ideal(z +1,  y^2 -y +1,  x^2 +x +1,  6*x*y -3*x +3*y +3),
  ideal(z,  x -y +1,  y^2 -y +1),
  ideal(z,  y^2 -y +1,  x*y +(-1/2)*x +(1/2)*y -1,  x^2 +x +1,  x +y),
  ideal(z^2 -z +1,  y^2 -y +1,  x*y +x*z +(-3/2)*y*z -x +(5/4)*y +(5/4)*z -7/2,  x^2 +x +1,  y -z,  x +z),
  ideal(y +z -1,  z^2 -z +1,  x^2 +x +1,  6*x*z -3*x +3*z -6),
  ideal(y +z -1,  z^2 -z +1,  x^2 +x +1,  6*x*z -3*x +3*z +3),
  ideal(z^2 -z +1,  y^2 -y +1,  x*y +x*z +(-3/2)*y*z -x +(5/4)*y +(5/4)*z -1/2,  x^2 +x +1,  y -z,  x -z +1),
  ideal(z +1,  y +1,  x^2 -x +1),
  ideal(z,  y +1,  x^2 -x +1),
  ideal(y +1,  z^2 -z +1,  x^2 -x +1,  -12*x*z +6*x +6*z -12),
  ideal(y +1,  z^2 -z +1,  x^2 -x +1,  -12*x*z +6*x +6*z +6),
  ideal(z +1,  y,  x^2 -x +1),
  ideal(z,  y,  x^2 -x +1),
  ideal(y,  z^2 -z +1,  x^2 -x +1,  -12*x*z +6*x +6*z -12),
  ideal(y,  z^2 -z +1,  x^2 -x +1,  -12*x*z +6*x +6*z +6),
  ideal(z +1,  y^2 -y +1,  x^2 -x +1,  -4*x*y +2*x +2*y +2),
  ideal(z +1,  y^2 -y +1,  x^2 -x +1,  -4*x*y +2*x +2*y -4),
  ideal(z,  y^2 -y +1,  x^2 -x +1,  -4*x*y +2*x +2*y +2),
  ideal(z,  y^2 -y +1,  x^2 -x +1,  -4*x*y +2*x +2*y -4),
  ideal(x +(1/2)*y +(-1/2)*z -1/2,  z^2 -z +1,  y^2 -y +1,  y*z +(-1/2)*y +(-1/2)*z -1/2,  y +z -1),
  ideal(z^2 -z +1,  y^2 -y +1,  x*y -x*z +(-1/2)*y*z +(-1/4)*y +(3/4)*z +7/4,  x^2 -x +1,  y +z -1,  x +z -1),
  ideal(y -z,  z^2 -z +1,  x^2 -x +1,  -4*x*z +2*x +2*z -4),
  ideal(y -z,  z^2 -z +1,  x^2 -x +1,  -4*x*z +2*x +2*z +2)]),
	    true);

